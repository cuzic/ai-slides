# Day2: AI活用リバースエンジニアリング演習

## Day2の新コンセプト

### 旧案（ボツ）
❌ 得意先マスターをゼロから作成
- 既存コードを参考にするだけ
- 実務とかけ離れている

### 新案（採用）
✅ 既存システム（NFBMS）をリバースエンジニアリング
- 実際の業務システムを理解する
- AIでドキュメントを自動生成
- 新機能（CSV取り込み→伝票入力）を設計
- 必要なマスターを実装

**より実務に近い！**

---

## Day2の目標

### 1. リバースエンジニアリングスキル
既存システムのソースコードと設計書から全体像を理解し、ドキュメント化する能力

### 2. AIによるドキュメント自動生成
- システム構成図
- データモデル図（ER図）
- 業務フロー図
- API仕様書
- テーブル定義書

### 3. 新機能の設計能力
CSV取り込み→伝票入力という新機能を、既存システムに追加する設計

### 4. マスター実装の実践
設計した新マスター（納入先変換など）を実装

---

## 対象システム: NFBMS（運賃請求管理システム）

### 現状
- 運送会社向け伝票登録・請求・支払い管理システム
- 5拠点で運用中
- Excelで統一した業務フローあり

### 新機能要件
**CSV取り込み→伝票入力の自動化**

#### 業務フロー
```
1. CSV取り込み
   ↓
2. マスターから金額計算
   ↓
3. CSV金額と突合・誤差チェック
   ↓
4. 集約処理（車両番号+便番号で1伝票に）
   ↓
5. 伝票登録
```

#### 必要なマスター
1. **納入先変換マスター**
   - 得意先コード → 納入先コード

2. **住所変換マスター**
   - 住所 → 納入先コード

3. **単価マスター（親子構造）**
   - 拠点共通の最低保障運賃
   - 2tトラック加算運賃
   - 現場作業加算運賃
   - 距離別・商品種類別単価
   - 返品時割引率（50%など）

#### 集約ルール
- **キー**: 車両番号 + 便番号
- **処理**: 同じキーの明細を1伝票にまとめる
- **現状**: Excelで手作業
- **目標**: システムで自動化

---

## Day2タイムテーブル（6時間）

### 【午前】リバースエンジニアリングとドキュメント生成（3時間）

#### 9:30-10:00 | システム概要の理解（30分）
**やること**:
- NFBMSの全体像を把握
- 設計書（Excel）を確認
- 既存のソースコード構成を確認

**成果物**:
- システム概要メモ

---

#### 10:00-11:00 | AIによるコード解析とER図生成（60分）
**やること**:
- DDLファイル（全テーブル）をAIに読み込ませる
- ER図を自動生成（Mermaid）
- テーブル関連図を作成
- データモデルを理解

**AIへのプロンプト例**:
```
以下のDDLファイルからER図をMermaid形式で作成してください。

要件:
1. マスターテーブル（m001～）と トランザクションテーブル（t001～）を区別
2. 主キー・外部キーの関係を明示
3. 重要な関連のみ表示（全部描くと複雑すぎるため）

[DDLファイルを貼り付け]
```

**成果物**:
- ER図（Mermaid）
- テーブル一覧表（Markdown）

---

#### 11:00-11:15 | 休憩（15分）

---

#### 11:15-12:30 | 業務フロー図とアーキテクチャ図の生成（75分）
**やること**:
- 既存機能の業務フロー図を生成
- システムアーキテクチャ図を作成
- Controller/Service/DAOの関係図

**AIへのプロンプト例**:
```
以下のControllerとServiceのコードから、
業務フロー図をMermaid（フローチャート）で作成してください。

特に以下の流れを明確に:
1. 画面からのリクエスト
2. バリデーション
3. ビジネスロジック
4. DB操作
5. レスポンス

[Controllerのコード]
[Serviceのコード]
```

**成果物**:
- 業務フロー図（請求処理など）
- アーキテクチャ図（レイヤー構造）
- API一覧表

---

### 【午後】新機能設計と実装（3時間）

#### 13:30-14:30 | CSV取り込み機能の設計（60分）
**やること**:
- CSV取り込みの仕様を設計
- 必要なマスターを定義
- 業務フロー図を作成

**演習内容**:

**Step 1: CSV形式の確認**
Excelファイルを確認し、CSV項目を洗い出す

**Step 2: 必要なマスターの設計**
AIに依頼して以下のマスター定義を作成:

1. **納入先変換マスター**
```sql
CREATE TABLE m026_delivery_conversion (
     baseCd NVARCHAR(2) NOT NULL           -- 拠点コード
    ,customerCd NVARCHAR(20) NOT NULL      -- 得意先コード
    ,csvDeliveryNm NVARCHAR(100) NOT NULL  -- CSV上の納入先名
    ,deliveryPointCd NVARCHAR(20) NOT NULL -- 変換後の納入先コード
    -- 共通項目
    ,delFlg INT DEFAULT 0 NOT NULL
    ,regUser NVARCHAR(20)
    ,regTime DATETIME
    ,updUser NVARCHAR(20)
    ,updTime DATETIME
     PRIMARY KEY (baseCd, customerCd, csvDeliveryNm)
);
```

2. **住所変換マスター**
```sql
CREATE TABLE m027_address_conversion (
     baseCd NVARCHAR(2) NOT NULL           -- 拠点コード
    ,address NVARCHAR(200) NOT NULL        -- 住所（部分一致検索用）
    ,deliveryPointCd NVARCHAR(20) NOT NULL -- 変換後の納入先コード
    -- 共通項目
    ,delFlg INT DEFAULT 0 NOT NULL
    ,regUser NVARCHAR(20)
    ,regTime DATETIME
    ,updUser NVARCHAR(20)
    ,updTime DATETIME
     PRIMARY KEY (baseCd, address)
);
```

**Step 3: 業務フロー図の作成**
AIに依頼してMermaidで作成:
```
CSV取り込み
  ↓
明細読み込み
  ↓
得意先コード変換（マスター参照）
  ↓
納入先コード変換（マスター参照）
  ↓
単価計算（単価マスター参照）
  ↓
金額突合・誤差チェック
  ↓
車両番号+便番号で集約
  ↓
伝票登録
```

**成果物**:
- マスターDDL
- 業務フロー図
- CSV→伝票変換仕様書

---

#### 14:30-15:30 | 納入先変換マスターの実装（60分）
**やること**:
- 納入先変換マスターの管理機能を実装

**実装範囲**:
- エンティティ
- DAO
- Service
- Controller
- 一覧・登録・編集・削除画面

**AIへのプロンプト例**:
```
m001_userを参考に、m026_delivery_conversion（納入先変換マスター）の
エンティティクラスを作成してください。

テーブル定義:
[DDLを貼り付け]

参考コード:
[M001UserEntity.javaを貼り付け]
```

**成果物**:
- M026関連のJavaコード一式

---

#### 15:30-15:45 | 休憩（15分）

---

#### 15:45-16:30 | 集約処理ロジックの設計（45分）
**やること**:
- 車両番号+便番号での集約処理を設計

**演習内容**:

**Step 1: 集約ルールの明確化**
```
キー: 車両番号 + 便番号
集約項目:
- 明細を配列で保持
- 金額を合計
- 数量を合計
```

**Step 2: 疑似コードの作成**
AIに依頼:
```
CSV明細リストから、車両番号と便番号が同じものを
1つの伝票にまとめる処理のJavaコードを作成してください。

入力: List<CsvMeisai>
出力: List<Denpyo>

処理:
1. 車両番号+便番号でグルーピング
2. 各グループ内の明細を1伝票にまとめる
3. 金額・数量を合計

Java 8のStreamAPIを使用してください。
```

**Step 3: ロジックのレビュー**
- 生成されたコードをAIにレビューさせる
- エッジケースを確認
- パフォーマンスを確認

**成果物**:
- 集約処理のServiceクラス
- 単体テストコード

---

#### 16:30-17:00 | 総括と振り返り（30分）
**やること**:
- 作成したドキュメントのレビュー
- 実務での活用方法の確認
- 質疑応答

**確認事項**:
- ER図は理解できたか？
- 業務フローは明確になったか？
- 新機能の設計はできたか？
- マスター実装は完了したか？

---

## Day2で作成する成果物

### 1. システムドキュメント（リバースエンジニアリング成果）
- [ ] システム概要書（README.md）
- [ ] ER図（Mermaid）
- [ ] テーブル定義書（Markdown表）
- [ ] 業務フロー図（Mermaid）
- [ ] アーキテクチャ図
- [ ] API一覧表

### 2. 新機能設計書
- [ ] CSV取り込み仕様書
- [ ] 納入先変換マスター定義
- [ ] 住所変換マスター定義
- [ ] 集約処理仕様書
- [ ] 業務フロー図（新機能）

### 3. 実装コード
- [ ] 納入先変換マスター（M026）
  - Entity, DAO, Service, Controller
  - HTML（一覧・登録・編集）
- [ ] 集約処理Service
- [ ] 単体テスト

---

## リバースエンジニアリングのポイント

### 1. 全体から詳細へ
❌ いきなりコードを読む
✅ まずER図で全体像を把握

### 2. AIを最大限活用
- DDL → ER図自動生成
- コード → フロー図自動生成
- 既存コード → 仕様書自動生成

### 3. ドキュメントは必須
- 理解したことを文書化
- AIも人間も、ドキュメントがあれば効率的
- 将来の自分のために残す

---

## 実務との対応

### Day2で学ぶこと = 実務でやること

#### ケース1: 既存システムの改修
1. ✅ 既存コードを読んで理解（リバースエンジニアリング）
2. ✅ AIでドキュメント生成
3. ✅ 新機能を設計
4. ✅ 実装

#### ケース2: 引き継ぎ
1. ✅ 前任者のコードを理解
2. ✅ ドキュメントがなければ作成
3. ✅ AIに要約させて効率化

#### ケース3: レガシーシステムの理解
1. ✅ 古いコードをAIに読ませる
2. ✅ 現代的なドキュメントに変換
3. ✅ リファクタリング計画を立てる

---

## Day1からの継続性

### Day1でやったこと
1. ✅ Claudeの基本操作
2. ✅ プロンプトの書き方
3. ✅ Mermaidでの図の作成
4. ✅ プロジェクトREADME.mdの作成
5. ✅ トークン数の管理

### Day2で活かすこと
1. ✅ DDLを読み込ませてER図生成 → **Mermaidスキル**
2. ✅ コードから仕様書生成 → **プロンプトスキル**
3. ✅ 新機能設計 → **プロジェクト理解**
4. ✅ マスター実装 → **コード生成スキル**

**Day1の学習が全て活きる！**

---

## よくある質問

### Q1: リバースエンジニアリングは難しくない？
A: AIが大部分を自動化してくれます。
- DDL → ER図は自動生成
- コード → フロー図も自動生成
- 人間は「確認」と「修正」だけ

### Q2: 6時間でドキュメント作成と実装は無理では？
A: 範囲を絞ります。
- 全テーブルのER図: 30分
- 主要フローのみ: 45分
- 1つのマスターだけ実装: 60分

### Q3: Excelの業務フローはどう使う？
A: 新機能設計の「答え」として使います。
- Excel = 業務要件の明確化
- システム = Excelの自動化

---

## 成功パターン

### パターン1: スムーズに進行
✅ 午前中にドキュメント全て完成
✅ 午後は実装とテストに集中
✅ 集約処理ロジックまで完成

### パターン2: 標準的な進行
✅ ER図と主要フロー図完成
✅ 納入先変換マスター実装完了
✅ 集約処理は設計のみ

### パターン3: 時間不足
⚠️ ER図とテーブル一覧完成
⚠️ 新機能設計のみ
⚠️ 実装は一部（エンティティのみなど）

**最低限「システム全体の理解」ができればOK**

---

## Day2の準備（Day1でやっておく）

### 絶対必要
1. ✅ プロジェクトREADME.mdの作成
2. ✅ DDLファイルの場所確認
3. ✅ Excelファイルの確認
4. ✅ Mermaidの基本操作習得

### あると良い
1. ⭕ 既存マスター（m001など）のコード確認
2. ⭕ 業務フローの大まかな理解

---

## まとめ: Day2の価値

### 従来の研修（ボツ案）
❌ 架空のマスターを作る
❌ 既存コードをコピペするだけ
❌ 実務とかけ離れている

### 新しいDay2（採用案）
✅ 実際の業務システムを理解
✅ リバースエンジニアリングを体験
✅ AIでドキュメント自動生成
✅ 新機能設計と実装
✅ **実務で即使える！**

---

## Day2終了時の状態

### 参加者が持ち帰るもの
1. NFBMSの全体像ドキュメント
2. ER図・フロー図
3. CSV取り込み機能の設計書
4. 納入先変換マスターの実装
5. リバースエンジニアリングのスキル

### 実務で活かせること
1. 既存システムの理解方法
2. AIによるドキュメント自動生成
3. レガシーコードの解析
4. 新機能の設計方法
5. ドキュメントの重要性

**即戦力になれる！**
