# TDD Cycle - 完全なTDDサイクルを実行

Complete TDD Cycle: Red → Green → Refactor → Verify → Commit の完全なサイクルを実行します。

## あなたの役割

完全なTDD（Test-Driven Development）サイクルを自動的に実行し、1つの機能を完成させます。

## TDDサイクルのフロー

```
┌─────────────────────────────────────────────┐
│  1. PLAN - テスト戦略を立てる               │
│     - 何をテストするか決める                 │
│     - テストケースの優先順位付け             │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  2. RED - 失敗するテストを書く              │
│     - テストを書く                          │
│     - テストを実行して失敗を確認             │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  3. GREEN - テストをパスする実装を書く      │
│     - 最小限のコードを書く                  │
│     - テストがパスすることを確認             │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  4. REFACTOR - コードを改善する             │
│     - 重複を排除                            │
│     - 命名を改善                            │
│     - 構造を改善                            │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  5. VERIFY - すべてのテストを確認           │
│     - テストスイート全体を実行               │
│     - カバレッジを確認                      │
│     - 品質基準を満たしているか確認           │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  6. COMMIT - 変更をコミット                 │
│     - git add                               │
│     - git commit                            │
│     - 次のサイクルへ                        │
└─────────────────────────────────────────────┘
```

## 実行手順

### Phase 1: PLAN（計画）

1. 現在のタスクを確認
2. テスト戦略を立案
3. テストケースをリストアップ
4. 最初のテストケースを選択

**出力**: テストケースのリストと実装計画

---

### Phase 2: RED（失敗するテストを書く）

1. テストファイルを作成/更新
2. 失敗するテストを書く
3. テストを実行して失敗を確認
4. 失敗の理由を確認

**期待される結果**: テストが失敗する（実装がないため）

---

### Phase 3: GREEN（テストをパスさせる）

1. テストをパスする最小限のコードを書く
2. テストを実行してパスを確認
3. 既存のテストが壊れていないことを確認

**期待される結果**: すべてのテストがパスする

---

### Phase 4: REFACTOR（リファクタリング）

1. コードの臭い（Code Smells）を特定
2. コードを改善（重複排除、命名改善、構造改善）
3. テストを実行して振る舞いが変わっていないことを確認

**期待される結果**: コードが改善され、テストは依然としてパスする

---

### Phase 5: VERIFY（検証）

1. テストスイート全体を実行
2. カバレッジレポートを確認
3. 品質基準を満たしているか確認

**期待される結果**: すべてのテストがパスし、品質基準を満たす

---

### Phase 6: COMMIT（コミット）

1. 変更をステージング（`git add`）
2. 明確なコミットメッセージでコミット
3. Todoリストを更新（完了タスクをマーク）

**出力**: コミット完了とサマリー

---

## 自動実行の流れ

このコマンドは以下を順次実行します：

1. **PLAN**: `/tdd-plan` の内容を実行
2. **RED**: `/tdd-red` の内容を実行
3. **GREEN**: `/tdd-green` の内容を実行
4. **REFACTOR**: `/tdd-refactor` の内容を実行
5. **VERIFY**: `/tdd-verify` の内容を実行
6. **COMMIT**: Git コミット実行

各フェーズで問題があれば停止し、ユーザーに報告します。

## 成功基準

### ✅ サイクル完了の条件

- [ ] テストが書かれた（Red phase）
- [ ] テストがパスした（Green phase）
- [ ] コードがリファクタリングされた（Refactor phase）
- [ ] すべてのテストがパスした（Verify phase）
- [ ] カバレッジが基準を満たした（80%以上）
- [ ] コミットが完了した

### チェックポイント

各フェーズで以下を確認：

| Phase | チェック項目 |
|-------|------------|
| PLAN | テストケースが明確に定義されている |
| RED | テストが失敗する（期待通り） |
| GREEN | テストがパスする |
| REFACTOR | コードが改善され、テストは依然としてパスする |
| VERIFY | すべてのテストがパスし、カバレッジが十分 |
| COMMIT | 変更がコミットされた |

## コミットメッセージの例

```
feat: Add customer code validation

- Add validation for customer code format (alphanumeric, max 6 chars)
- Add master data existence check
- Add error messages for invalid customer codes

Test: A00104RegisterFormTest, A001ServiceTest
Coverage: 87% (target: 80%)

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

## エラー処理

### Phase 2 (RED) でエラー

**問題**: テストが書けない、またはテストが期待通り失敗しない

**対処**:
1. テスト戦略を見直す
2. より単純なテストケースから始める
3. `/tdd-plan` に戻って計画を修正

### Phase 3 (GREEN) でエラー

**問題**: テストがパスしない、または他のテストが壊れる

**対処**:
1. 実装を見直す
2. より単純な実装から始める
3. 必要に応じて `/tdd-red` に戻ってテストを修正

### Phase 5 (VERIFY) でエラー

**問題**: 一部のテストが失敗する、またはカバレッジが不十分

**対処**:
1. 失敗したテストを修正
2. カバレッジされていない部分にテストを追加
3. `/tdd-red` から再度サイクルを回す

## 完了後のアクション

### パターンA: 次のテストケースへ

現在のタスクに対してさらにテストケースが必要な場合：
→ 再度 `/tdd-cycle` を実行

### パターンB: 次のタスクへ

現在のタスクが完了した場合：
→ Todoリストの次のタスクに移動し、新しい `/tdd-cycle` を開始

### パターンC: 統合テストへ

単体テストが完了した場合：
→ 統合テストフェーズに移行

## サマリーレポート

完了時に以下の情報を出力：

```markdown
## TDD Cycle Summary

### Completed Tasks
✅ PLAN: Customer code validation test strategy
✅ RED: shouldReturnErrorWhenCustomerCdIsEmpty test (FAILED as expected)
✅ GREEN: Added validation logic (ALL TESTS PASS)
✅ REFACTOR: Extracted validation method (ALL TESTS PASS)
✅ VERIFY: All 15 tests pass, Coverage 87%
✅ COMMIT: feat: Add customer code validation

### Statistics
- Tests Added: 3
- Tests Passed: 15/15
- Coverage: 87% (Line), 82% (Branch)
- Duration: 8 minutes
- Commits: 1

### Next Steps
現在のタスクに対してさらにテストケースが必要です。
次のテストケース: "運送店CDのバリデーション"

実行コマンド: `/tdd-cycle` (次のテストケース)
または: 次のタスクに移動
```

---

完全なTDDサイクルを実行して、1つの機能を完成させます。
現在のタスクに対してRed-Green-Refactor-Verify-Commitのサイクルを回してください。
